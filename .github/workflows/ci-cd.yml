name: CI/CD - UWB Visualiser v4.0

on:
  push:
    branches: [ main, develop, cga-jen ]
  pull_request:
    branches: [ main, cga-jen ]
  schedule:
    # Run weekly dependency security check
    - cron: '0 0 * * 0'

env:
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.11'

jobs:
  # ===============================================
  # CODE QUALITY & VALIDATION
  # ===============================================
  
  validate:
    name: üîç Code Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      
    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: üì¶ Install Validation Dependencies
      run: |
        npm install --no-save stylelint eslint
        
    - name: üì¶ Install ESLint Table Formatter
      run: npm install -D eslint-formatter-table
        
    - name: üé® CSS Linting
      run: |
        echo "üîç Linting CSS files..."
        npx stylelint "css/**/*.css" --formatter verbose --max-warnings 999
        
    - name: ‚ö° JavaScript Linting
      run: |
        echo "üîç Linting JavaScript files..."
        npx eslint "js/**/*.js" --format table --quiet
        
    - name: üìä Check File Sizes
      run: |
        echo "üìä Checking asset file sizes..."
        find . -name "*.css" -exec wc -c {} + | sort -n
        find . -name "*.js" -exec wc -c {} + | sort -n
        

        
  # ===============================================
  # BROWSER COMPATIBILITY TESTING
  # ===============================================
  
  browser-test:
    name: üåê Browser Compatibility Tests
    runs-on: ubuntu-latest
    needs: validate
    if: false  # Temporarily disabled due to browser test issues
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: üì¶ Install Dependencies
      run: |
        npm ci
        npx playwright install --with-deps ${{ matrix.browser }}
        
    - name: üöÄ Start Test Server
      run: |
        echo "üöÄ Starting development server..."
        npm start &
        SERVER_PID=$!
        
        # Wait for server to be ready
        echo "‚è≥ Waiting for server to start..."
        for i in {1..30}; do
          if curl -f http://localhost:8080 >/dev/null 2>&1; then
            echo "‚úÖ Server is ready!"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "‚ùå Server failed to start within 30 seconds"
            exit 1
          fi
          sleep 1
        done
        
    - name: üß™ Run Browser Tests
      run: |
        echo "üß™ Testing in ${{ matrix.browser }}..."
        npx playwright test --config=config/playwrite.config.js --project=${{ matrix.browser }}
        
    - name: üìä Upload Test Results
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-results-${{ matrix.browser }}
        path: test-results/
        
  # ===============================================
  # MQTT INTEGRATION TESTING
  # ===============================================
  
  mqtt-test:
    name: üì° MQTT Integration Tests
    runs-on: ubuntu-latest
    needs: validate
    
    services:
      mosquitto:
        image: eclipse-mosquitto:latest
        ports:
          - 1883:1883
          - 9001:9001
        options: >-
          --health-cmd "mosquitto_pub -h localhost -t test -m 'health check'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3
          
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: üì¶ Install Python Dependencies
      run: |
        pip install paho-mqtt numpy pytest
        
    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: üì¶ Install Node Dependencies
      run: npm ci
      
    - name: üöÄ Start Application Server
      run: |
        npm start &
        sleep 5
        
    - name: üì° Test MQTT Publisher
      run: |
        echo "üì° Testing MQTT data publisher..."
        cd examples
        timeout 30s python mqtt-live-publisher.py --test-mode --mqtt-broker localhost || true
        
    - name: üß™ MQTT Integration Tests
      run: |
        echo "üß™ Running MQTT integration tests..."
        python -m pytest tests/mqtt-integration-test.py -v
        
  # ===============================================
  # PERFORMANCE TESTING
  # ===============================================
  
  performance:
    name: ‚ö° Performance Tests
    runs-on: ubuntu-latest
    needs: validate
    if: always()
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      
    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: üì¶ Install Dependencies
      run: |
        npm ci
        npm install -g lighthouse
        
    - name: üöÄ Start Server
      run: |
        echo "üöÄ Starting development server..."
        npm start &
        SERVER_PID=$!
        
        # Wait for server to be ready
        echo "‚è≥ Waiting for server to start..."
        for i in {1..30}; do
          if curl -f http://localhost:8080 >/dev/null 2>&1; then
            echo "‚úÖ Server is ready!"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "‚ùå Server failed to start within 30 seconds"
            exit 1
          fi
          sleep 1
        done
        
    - name: üî• Lighthouse Performance Audit
      run: |
        echo "üî• Running Lighthouse performance audit..."
        # Double-check server is running
        if ! curl -f http://localhost:8080 >/dev/null 2>&1; then
          echo "‚ùå Server is not responding before Lighthouse test"
          exit 1
        fi
        
        # Run Lighthouse with better error handling
        lighthouse http://localhost:8080 \
          --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage" \
          --output=json \
          --output-path=./lighthouse-report.json \
          --preset=desktop \
          --timeout=60000 || {
          echo "‚ùå Lighthouse failed to run"
          exit 1
        }
          
    - name: üìä Performance Budget Check
      run: |
        echo "üìä Checking performance metrics..."
        node -e "
          try {
            const report = require('./lighthouse-report.json');
            
            // Handle different Lighthouse report formats
            let scores = {};
            if (report.lhr && report.lhr.categories) {
              scores = report.lhr.categories;
            } else if (report.categories) {
              scores = report.categories;
            } else {
              console.error('‚ùå Could not find categories in Lighthouse report');
              console.log('Report structure:', JSON.stringify(report, null, 2));
              process.exit(1);
            }
            
            console.log('Performance Scores:');
            if (scores.performance && scores.performance.score !== undefined) {
              console.log('Performance:', Math.round(scores.performance.score * 100));
            } else {
              console.log('Performance: N/A');
            }
            
            if (scores.accessibility && scores.accessibility.score !== undefined) {
              console.log('Accessibility:', Math.round(scores.accessibility.score * 100));
            } else {
              console.log('Accessibility: N/A');
            }
            
            if (scores['best-practices'] && scores['best-practices'].score !== undefined) {
              console.log('Best Practices:', Math.round(scores['best-practices'].score * 100));
            } else {
              console.log('Best Practices: N/A');
            }
            
            if (scores.seo && scores.seo.score !== undefined) {
              console.log('SEO:', Math.round(scores.seo.score * 100));
            } else {
              console.log('SEO: N/A');
            }
            
            // Only fail if performance score exists and is below threshold
            if (scores.performance && scores.performance.score !== undefined) {
              if (scores.performance.score < 0.85) {
                console.error('‚ùå Performance score below threshold!');
                process.exit(1);
              }
            }
            
            console.log('‚úÖ Performance tests passed!');
          } catch (error) {
            console.error('‚ùå Error processing Lighthouse report:', error.message);
            console.log('Report structure:', JSON.stringify(require('./lighthouse-report.json'), null, 2));
            process.exit(1);
          }
        "
        
    - name: üì§ Upload Performance Report
      uses: actions/upload-artifact@v4
      with:
        name: lighthouse-report
        path: lighthouse-report.json
        
  # ===============================================
  # BUILD APPLICATION
  # ===============================================
  
  build:
    name: üèóÔ∏è Build Application
    runs-on: ubuntu-latest
    needs: [validate, mqtt-test]
    if: always()
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      
    - name: üóÇÔ∏è Create Build Directory
      run: mkdir -p dist
      
    - name: üìã Copy All Files
      run: |
        echo "üìã Copying all application files..."
        cp -r js/ dist/
        cp -r css/ dist/
        cp -r examples/ dist/
        cp -r docs/ dist/
        cp README.md LICENSE dist/
        cp index.html dist/
        [ -d resources/ ] && cp -r resources/ dist/ || echo "No resources directory"
        
    - name: üìä Build Report
      run: |
        echo "üìä Build Summary:"
        echo "‚îú‚îÄ‚îÄ JavaScript files: $(find dist/js -name '*.js' | wc -l)"
        echo "‚îú‚îÄ‚îÄ CSS files: $(find dist/css -name '*.css' | wc -l)"
        echo "‚îú‚îÄ‚îÄ HTML file: $(wc -c < dist/index.html) bytes"
        echo "‚îî‚îÄ‚îÄ Total build size: $(du -sh dist | cut -f1)"
        
    - name: üì§ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/
        retention-days: 30
        
  # ===============================================
  # SECURITY SCANNING
  # ===============================================
  
  security:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    needs: validate
    if: always()
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      
    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: üì¶ Install Dependencies
      run: npm ci
      
    - name: üîç CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        
    - name: üèóÔ∏è Autobuild
      uses: github/codeql-action/autobuild@v3
      
    - name: üìä CodeQL Analysis Results
      uses: github/codeql-action/analyze@v3
      
    - name: üîí Dependency Vulnerability Scan
      run: |
        echo "üîí Running dependency vulnerability scan..."
        npm audit --audit-level moderate || echo "‚ö†Ô∏è Audit found vulnerabilities (continuing anyway for cga-jen branch)"
        
  # ===============================================
  # DEPLOYMENT TO GITHUB PAGES
  # ===============================================
  
  deploy:
    name: üöÄ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build, performance, security]
    if: github.event_name == 'push'
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      
    - name: üì• Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: dist/
        
    - name: üîß Setup GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: üì¶ Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: dist/
        
    - name: üöÄ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      continue-on-error: true
      
    - name: üéâ Deployment Success
      if: success()
      run: |
        echo "üéâ Successfully deployed ${{ github.ref_name }} branch to GitHub Pages!"
        echo "üåê URL: ${{ steps.deployment.outputs.page_url }}"
        
    - name: ‚ö†Ô∏è Deployment Warning
      if: failure()
      run: |
        echo "‚ö†Ô∏è Deployment may have failed due to concurrent deployment in progress"
        echo "This is normal when multiple commits are pushed quickly"
        echo "The ${{ github.ref_name }} site should be available shortly at: https://dynamicdevices.github.io/inst-visualiser/"
        
  # ===============================================
  # NOTIFICATION & REPORTING
  # ===============================================
  
  notify:
    name: üì¢ Build Notifications
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
    - name: üìä Build Status Report
      run: |
        echo "üìä CI/CD Pipeline Summary:"
        echo "‚îú‚îÄ‚îÄ Validation: ${{ needs.validate.result }}"
        echo "‚îú‚îÄ‚îÄ Browser Tests: ${{ needs.browser-test.result }}"
        echo "‚îú‚îÄ‚îÄ MQTT Tests: ${{ needs.mqtt-test.result }}"
        echo "‚îú‚îÄ‚îÄ Performance: ${{ needs.performance.result }}"
        echo "‚îú‚îÄ‚îÄ Build: ${{ needs.build.result }}"
        echo "‚îú‚îÄ‚îÄ Security: ${{ needs.security.result }}"
        echo "‚îî‚îÄ‚îÄ Deploy: ${{ needs.deploy.result }}"
        
    - name: üìß Success Notification
      if: needs.deploy.result == 'success'
      run: |
        echo "‚úÖ UWB Visualiser v4.0 (${{ github.ref_name }} branch) successfully deployed!"
        echo "üåê Live at: https://dynamicdevices.github.io/inst-visualiser/"
        
    - name: ‚ùå Failure Notification
      if: failure()
      run: |
        echo "‚ùå CI/CD Pipeline failed!"
        echo "Please check the logs above for details."