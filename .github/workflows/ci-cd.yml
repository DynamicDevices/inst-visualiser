name: CI/CD - UWB Visualiser v4.0

on:
  push:
    branches: [ main, develop, cga-jen ]
  pull_request:
    branches: [ main, cga-jen ]
  schedule:
    # Run weekly dependency security check
    - cron: '0 0 * * 0'

env:
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.11'

jobs:
  # ===============================================
  # CODE QUALITY & VALIDATION
  # ===============================================
  
  validate:
    name: ğŸ” Code Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install Validation Dependencies
      run: |
        npm install --no-save stylelint eslint
        
    - name: ğŸ“¦ Install ESLint Table Formatter
      run: npm install -D eslint-formatter-table
        
    - name: ğŸ¨ CSS Linting
      run: |
        echo "ğŸ” Linting CSS files..."
        npx stylelint "css/**/*.css" --formatter verbose --max-warnings 999
        
    - name: âš¡ JavaScript Linting
      run: |
        echo "ğŸ” Linting JavaScript files..."
        npx eslint "js/**/*.js" --format table --quiet
        
    - name: ğŸ“Š Check File Sizes
      run: |
        echo "ğŸ“Š Checking asset file sizes..."
        find . -name "*.css" -exec wc -c {} + | sort -n
        find . -name "*.js" -exec wc -c {} + | sort -n
        

        
  # ===============================================
  # BROWSER COMPATIBILITY TESTING
  # ===============================================
  
  browser-test:
    name: ğŸŒ Browser Compatibility Tests
    runs-on: ubuntu-latest
    needs: validate
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        npm ci
        npx playwright install --with-deps ${{ matrix.browser }}
        
    - name: ğŸš€ Start Test Server
      run: |
        npm start &
        sleep 5
        curl -f http://localhost:8080 || exit 1
        
    - name: ğŸ§ª Run Browser Tests
      run: |
        echo "ğŸ§ª Testing in ${{ matrix.browser }}..."
        npx playwright test --config=config/playwrite.config.js --browser=${{ matrix.browser }} tests/browser-tests.js
        
    - name: ğŸ“Š Upload Test Results
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-results-${{ matrix.browser }}
        path: test-results/
        
  # ===============================================
  # MQTT INTEGRATION TESTING
  # ===============================================
  
  mqtt-test:
    name: ğŸ“¡ MQTT Integration Tests
    runs-on: ubuntu-latest
    needs: validate
    
    services:
      mosquitto:
        image: eclipse-mosquitto:latest
        ports:
          - 1883:1883
          - 9001:9001
        options: >-
          --health-cmd "mosquitto_pub -h localhost -t test -m 'health check'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3
          
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install Python Dependencies
      run: |
        pip install paho-mqtt numpy pytest
        
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Node Dependencies
      run: npm ci
      
    - name: ğŸš€ Start Application Server
      run: |
        npm start &
        sleep 5
        
    - name: ğŸ“¡ Test MQTT Publisher
      run: |
        echo "ğŸ“¡ Testing MQTT data publisher..."
        cd examples
        timeout 30s python mqtt-live-publisher.py --test-mode --mqtt-broker localhost || true
        
    - name: ğŸ§ª MQTT Integration Tests
      run: |
        echo "ğŸ§ª Running MQTT integration tests..."
        python -m pytest tests/mqtt-integration-test.py -v
        
  # ===============================================
  # PERFORMANCE TESTING
  # ===============================================
  
  performance:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: validate
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        npm ci
        npm install -g lighthouse
        
    - name: ğŸš€ Start Server
      run: |
        npm start &
        sleep 5
        
    - name: ğŸ”¥ Lighthouse Performance Audit
      run: |
        echo "ğŸ”¥ Running Lighthouse performance audit..."
        lighthouse http://localhost:8080 \
          --chrome-flags="--headless --no-sandbox" \
          --output=json \
          --output-path=./lighthouse-report.json \
          --preset=desktop
          
    - name: ğŸ“Š Performance Budget Check
      run: |
        echo "ğŸ“Š Checking performance metrics..."
        node -e "
          try {
            const report = require('./lighthouse-report.json');
            
            // Handle different Lighthouse report formats
            let scores = {};
            if (report.lhr && report.lhr.categories) {
              scores = report.lhr.categories;
            } else if (report.categories) {
              scores = report.categories;
            } else {
              console.error('âŒ Could not find categories in Lighthouse report');
              console.log('Report structure:', JSON.stringify(report, null, 2));
              process.exit(1);
            }
            
            console.log('Performance Scores:');
            if (scores.performance && scores.performance.score !== undefined) {
              console.log('Performance:', Math.round(scores.performance.score * 100));
            } else {
              console.log('Performance: N/A');
            }
            
            if (scores.accessibility && scores.accessibility.score !== undefined) {
              console.log('Accessibility:', Math.round(scores.accessibility.score * 100));
            } else {
              console.log('Accessibility: N/A');
            }
            
            if (scores['best-practices'] && scores['best-practices'].score !== undefined) {
              console.log('Best Practices:', Math.round(scores['best-practices'].score * 100));
            } else {
              console.log('Best Practices: N/A');
            }
            
            if (scores.seo && scores.seo.score !== undefined) {
              console.log('SEO:', Math.round(scores.seo.score * 100));
            } else {
              console.log('SEO: N/A');
            }
            
            // Only fail if performance score exists and is below threshold
            if (scores.performance && scores.performance.score !== undefined) {
              if (scores.performance.score < 0.85) {
                console.error('âŒ Performance score below threshold!');
                process.exit(1);
              }
            }
            
            console.log('âœ… Performance tests passed!');
          } catch (error) {
            console.error('âŒ Error processing Lighthouse report:', error.message);
            console.log('Report structure:', JSON.stringify(require('./lighthouse-report.json'), null, 2));
            process.exit(1);
          }
        "
        
    - name: ğŸ“¤ Upload Performance Report
      uses: actions/upload-artifact@v4
      with:
        name: lighthouse-report
        path: lighthouse-report.json
        
  # ===============================================
  # BUILD APPLICATION
  # ===============================================
  
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: [validate, browser-test, mqtt-test]
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ—‚ï¸ Create Build Directory
      run: mkdir -p dist
      
    - name: ğŸ“‹ Copy All Files
      run: |
        echo "ğŸ“‹ Copying all application files..."
        cp -r js/ dist/
        cp -r css/ dist/
        cp -r examples/ dist/
        cp -r docs/ dist/
        cp README.md LICENSE dist/
        cp index.html dist/
        [ -d resources/ ] && cp -r resources/ dist/ || echo "No resources directory"
        
    - name: ğŸ“Š Build Report
      run: |
        echo "ğŸ“Š Build Summary:"
        echo "â”œâ”€â”€ JavaScript files: $(find dist/js -name '*.js' | wc -l)"
        echo "â”œâ”€â”€ CSS files: $(find dist/css -name '*.css' | wc -l)"
        echo "â”œâ”€â”€ HTML file: $(wc -c < dist/index.html) bytes"
        echo "â””â”€â”€ Total build size: $(du -sh dist | cut -f1)"
        
    - name: ğŸ“¤ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/
        retention-days: 30
        
  # ===============================================
  # SECURITY SCANNING
  # ===============================================
  
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: validate
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ” CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        
    - name: ğŸ—ï¸ Autobuild
      uses: github/codeql-action/autobuild@v3
      
    - name: ğŸ“Š CodeQL Analysis Results
      uses: github/codeql-action/analyze@v3
      
    - name: ğŸ”’ Dependency Vulnerability Scan
      run: |
        echo "ğŸ”’ Running dependency vulnerability scan..."
        npm audit --audit-level moderate || echo "âš ï¸ Audit found vulnerabilities (continuing anyway for cga-jen branch)"
        
  # ===============================================
  # DEPLOYMENT TO GITHUB PAGES
  # ===============================================
  
  deploy:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build, performance, security]
    if: github.event_name == 'push'
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: dist/
        
    - name: ğŸ”§ Setup GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: ğŸ“¦ Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: dist/
        
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      continue-on-error: true
      
    - name: ğŸ‰ Deployment Success
      if: success()
      run: |
        echo "ğŸ‰ Successfully deployed ${{ github.ref_name }} branch to GitHub Pages!"
        echo "ğŸŒ URL: ${{ steps.deployment.outputs.page_url }}"
        
    - name: âš ï¸ Deployment Warning
      if: failure()
      run: |
        echo "âš ï¸ Deployment may have failed due to concurrent deployment in progress"
        echo "This is normal when multiple commits are pushed quickly"
        echo "The ${{ github.ref_name }} site should be available shortly at: https://dynamicdevices.github.io/inst-visualiser/"
        
  # ===============================================
  # NOTIFICATION & REPORTING
  # ===============================================
  
  notify:
    name: ğŸ“¢ Build Notifications
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
    - name: ğŸ“Š Build Status Report
      run: |
        echo "ğŸ“Š CI/CD Pipeline Summary:"
        echo "â”œâ”€â”€ Validation: ${{ needs.validate.result }}"
        echo "â”œâ”€â”€ Browser Tests: ${{ needs.browser-test.result }}"
        echo "â”œâ”€â”€ MQTT Tests: ${{ needs.mqtt-test.result }}"
        echo "â”œâ”€â”€ Performance: ${{ needs.performance.result }}"
        echo "â”œâ”€â”€ Build: ${{ needs.build.result }}"
        echo "â”œâ”€â”€ Security: ${{ needs.security.result }}"
        echo "â””â”€â”€ Deploy: ${{ needs.deploy.result }}"
        
    - name: ğŸ“§ Success Notification
      if: needs.deploy.result == 'success'
      run: |
        echo "âœ… UWB Visualiser v4.0 (${{ github.ref_name }} branch) successfully deployed!"
        echo "ğŸŒ Live at: https://dynamicdevices.github.io/inst-visualiser/"
        
    - name: âŒ Failure Notification
      if: failure()
      run: |
        echo "âŒ CI/CD Pipeline failed!"
        echo "Please check the logs above for details."