name: CI/CD - UWB Visualiser v4.0

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly dependency security check
    - cron: '0 0 * * 0'

env:
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.11'

jobs:
  # ===============================================
  # CODE QUALITY & VALIDATION
  # ===============================================
  
  validate:
    name: ğŸ” Code Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install Node Dependencies
      run: npm ci

    - name: ğŸ“¦ Install Python html5validator
      run: pip install html5validator

    - name: ğŸŒ HTML Validation
      run: |
        echo "ğŸ” Validating HTML structure..."
        html5validator --root . --match "*.html" --verbose
        
    - name: ğŸ¨ CSS Linting
      run: |
        echo "ğŸ” Linting CSS files..."
        npx stylelint "css/**/*.css" --formatter verbose
        
    - name: âš¡ JavaScript Linting
      run: |
        echo "ğŸ” Linting JavaScript files..."
        npx eslint "js/**/*.js" --format table
        
    - name: ğŸ“Š Check File Sizes
      run: |
        echo "ğŸ“Š Checking asset file sizes..."
        find . -name "*.css" -exec wc -c {} + | sort -n
        find . -name "*.js" -exec wc -c {} + | sort -n
        
    - name: ğŸ”’ Security Audit
      run: |
        echo "ğŸ”’ Running security audit..."
        npm audit --audit-level high
        
  # ===============================================
  # BROWSER COMPATIBILITY TESTING
  # ===============================================
  
  browser-test:
    name: ğŸŒ Browser Compatibility Tests
    runs-on: ubuntu-latest
    needs: validate
    
    strategy:
      matrix:
        browser: [chrome, firefox, edge]
        
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        npm ci
        npm install -g playwright
        npx playwright install --with-deps ${{ matrix.browser }}
        
    - name: ğŸš€ Start Test Server
      run: |
        npm start &
        sleep 5
        curl -f http://localhost:8080 || exit 1
        
    - name: ğŸ§ª Run Browser Tests
      run: |
        echo "ğŸ§ª Testing in ${{ matrix.browser }}..."
        npx playwright test --browser=${{ matrix.browser }} tests/browser-tests.js
        
    - name: ğŸ“Š Upload Test Results
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-results-${{ matrix.browser }}
        path: test-results/
        
  # ===============================================
  # MQTT INTEGRATION TESTING
  # ===============================================
  
  mqtt-test:
    name: ğŸ“¡ MQTT Integration Tests
    runs-on: ubuntu-latest
    needs: validate
    
    services:
      mosquitto:
        image: eclipse-mosquitto:latest
        ports:
          - 1883:1883
          - 9001:9001
        options: >-
          --health-cmd "mosquitto_pub -h localhost -t test -m 'health check'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3
          
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install Python Dependencies
      run: |
        pip install paho-mqtt numpy pytest
        
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Node Dependencies
      run: npm ci
      
    - name: ğŸš€ Start Application Server
      run: |
        npm start &
        sleep 5
        
    - name: ğŸ“¡ Test MQTT Publisher
      run: |
        echo "ğŸ“¡ Testing MQTT data publisher..."
        cd examples
        timeout 30s python mqtt-live-publisher.py --test-mode --mqtt-broker localhost || true
        
    - name: ğŸ§ª MQTT Integration Tests
      run: |
        echo "ğŸ§ª Running MQTT integration tests..."
        python -m pytest tests/test_mqtt_integration.py -v
        
  # ===============================================
  # PERFORMANCE TESTING
  # ===============================================
  
  performance:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        npm ci
        npm install -g lighthouse
        
    - name: ğŸš€ Start Server
      run: |
        npm start &
        sleep 5
        
    - name: ğŸ”¥ Lighthouse Performance Audit
      run: |
        echo "ğŸ”¥ Running Lighthouse performance audit..."
        lighthouse http://localhost:8080 \
          --chrome-flags="--headless --no-sandbox" \
          --output=json \
          --output-path=./lighthouse-report.json \
          --preset=desktop
          
    - name: ğŸ“Š Performance Budget Check
      run: |
        echo "ğŸ“Š Checking performance metrics..."
        node -e "
          const report = require('./lighthouse-report.json');
          const scores = report.lhr.categories;
          
          console.log('Performance Scores:');
          console.log('Performance:', Math.round(scores.performance.score * 100));
          console.log('Accessibility:', Math.round(scores.accessibility.score * 100));
          console.log('Best Practices:', Math.round(scores['best-practices'].score * 100));
          console.log('SEO:', Math.round(scores.seo.score * 100));
          
          // Fail if performance is below 85
          if (scores.performance.score < 0.85) {
            console.error('âŒ Performance score below threshold!');
            process.exit(1);
          }
          
          console.log('âœ… Performance tests passed!');
        "
        
    - name: ğŸ“¤ Upload Performance Report
      uses: actions/upload-artifact@v4
      with:
        name: lighthouse-report
        path: lighthouse-report.json
        
  # ===============================================
  # BUILD & MINIFICATION
  # ===============================================
  
  build:
    name: ğŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: [validate, browser-test, mqtt-test]
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        npm ci
        npm install -g terser clean-css-cli html-minifier
        
    - name: ğŸ—‚ï¸ Create Build Directory
      run: mkdir -p dist
      
    - name: ğŸ¨ Minify CSS
      run: |
        echo "ğŸ¨ Minifying CSS files..."
        cleancss -o dist/main.min.css css/main.css
        echo "Original size: $(wc -c < css/main.css) bytes"
        echo "Minified size: $(wc -c < dist/main.min.css) bytes"
        
    - name: âš¡ Minify JavaScript
      run: |
        echo "âš¡ Minifying JavaScript files..."
        terser js/visualizer.js -o dist/visualizer.min.js -c -m
        echo "Original size: $(wc -c < js/visualizer.js) bytes"
        echo "Minified size: $(wc -c < dist/visualizer.min.js) bytes"
        
    - name: ğŸŒ Minify HTML
      run: |
        echo "ğŸŒ Minifying HTML..."
        html-minifier --collapse-whitespace \
          --remove-comments \
          --remove-optional-tags \
          --remove-redundant-attributes \
          --remove-script-type-attributes \
          --remove-tag-whitespace \
          --use-short-doctype \
          --minify-css true \
          --minify-js true \
          -o dist/index.html index.html
          
    - name: ğŸ“‹ Copy Assets
      run: |
        echo "ğŸ“‹ Copying additional assets..."
        cp -r examples/ dist/
        cp -r docs/ dist/
        cp README.md LICENSE dist/
        [ -d resources/ ] && cp -r resources/ dist/ || echo "No resources directory"
        
    - name: ğŸ“Š Build Report
      run: |
        echo "ğŸ“Š Build Summary:"
        echo "â”œâ”€â”€ CSS: $(wc -c < dist/main.min.css) bytes"
        echo "â”œâ”€â”€ JS:  $(wc -c < dist/visualizer.min.js) bytes"
        echo "â”œâ”€â”€ HTML: $(wc -c < dist/index.html) bytes"
        echo "â””â”€â”€ Total build size: $(du -sh dist | cut -f1)"
        
    - name: ğŸ“¤ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: dist/
        retention-days: 30
        
  # ===============================================
  # SECURITY SCANNING
  # ===============================================
  
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ” CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        
    - name: ğŸ—ï¸ Autobuild
      uses: github/codeql-action/autobuild@v3
      
    - name: ğŸ“Š CodeQL Analysis Results
      uses: github/codeql-action/analyze@v3
      
    - name: ğŸ”’ Dependency Vulnerability Scan
      run: |
        npm audit --audit-level moderate
        
  # ===============================================
  # DEPLOYMENT TO GITHUB PAGES
  # ===============================================
  
  deploy:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build, performance, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: dist/
        
    - name: ğŸ”§ Setup GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: ğŸ“¦ Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: dist/
        
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: ğŸ‰ Deployment Success
      run: |
        echo "ğŸ‰ Successfully deployed to GitHub Pages!"
        echo "ğŸŒ URL: ${{ steps.deployment.outputs.page_url }}"
        
  # ===============================================
  # NOTIFICATION & REPORTING
  # ===============================================
  
  notify:
    name: ğŸ“¢ Build Notifications
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
    - name: ğŸ“Š Build Status Report
      run: |
        echo "ğŸ“Š CI/CD Pipeline Summary:"
        echo "â”œâ”€â”€ Validation: ${{ needs.validate.result }}"
        echo "â”œâ”€â”€ Browser Tests: ${{ needs.browser-test.result }}"
        echo "â”œâ”€â”€ MQTT Tests: ${{ needs.mqtt-test.result }}"
        echo "â”œâ”€â”€ Performance: ${{ needs.performance.result }}"
        echo "â”œâ”€â”€ Build: ${{ needs.build.result }}"
        echo "â”œâ”€â”€ Security: ${{ needs.security.result }}"
        echo "â””â”€â”€ Deploy: ${{ needs.deploy.result }}"
        
    - name: ğŸ“§ Success Notification
      if: needs.deploy.result == 'success'
      run: |
        echo "âœ… UWB Visualiser v4.0 successfully deployed!"
        echo "ğŸŒ Live at: https://dynamicdevices.github.io/inst-visualiser/"
        
    - name: âŒ Failure Notification
      if: failure()
      run: |
        echo "âŒ CI/CD Pipeline failed!"
        echo "Please check the logs above for details."